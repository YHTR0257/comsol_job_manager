@echo off
REM COMSOL Batch Execution Script
REM Generated by ESP Job Generator
REM Job ID: << job_id >>
REM Generated at: << generated_at >>

echo ============================================================
echo COMSOL Simulation Batch Execution
echo ============================================================
echo Job ID: << job_id >>
echo Job Directory: << job_dir >>
echo Java File: << java_file_name >>
echo Class Name: << class_name >>
echo Output File: << output_file >>
echo ============================================================

cd /d "<< job_dir >>"

REM Create results directory if it doesn't exist
if not exist "results" mkdir results

REM ============================================================
REM Step 1: Compile Java file with COMSOL
REM ============================================================
echo.
echo [%date% %time%] Step 1/4: Compiling Java file...
comsolcompile "<< java_file_name >>"

if %ERRORLEVEL% neq 0 (
    echo [%date% %time%] ERROR: Compilation failed with exit code %ERRORLEVEL%
    echo Check log file: results\compile.log
    exit /b %ERRORLEVEL%
)
echo [%date% %time%] Compilation completed successfully

REM ============================================================
REM Step 2: Verify .class file exists
REM ============================================================
echo.
echo [%date% %time%] Step 2/4: Verifying compiled class file...
if not exist "<< class_name >>.class" (
    echo [%date% %time%] ERROR: Compiled class file not found: << class_name >>.class
    exit /b 1
)
echo [%date% %time%] Class file verified: << class_name >>.class

REM ============================================================
REM Step 3: Execute COMSOL batch simulation
REM ============================================================
echo.
echo [%date% %time%] Step 3/4: Running COMSOL batch simulation...
comsolbatch ^
    -inputfile "<< class_name >>.class" ^
    -outputfile "<< class_name >>.mph" ^
    -batchlog "results\simulation.log" ^
    -batchlogout ^
    -np << num_cores >>

set EXIT_CODE=%ERRORLEVEL%

if %EXIT_CODE% neq 0 (
    echo [%date% %time%] ERROR: COMSOL batch execution failed with exit code %EXIT_CODE%
    echo Check log file: results\simulation.log
    exit /b %EXIT_CODE%
)
echo [%date% %time%] COMSOL batch execution completed successfully

REM ============================================================
REM Step 4: Verify output .mph file exists
REM ============================================================
echo.
echo [%date% %time%] Step 4/4: Verifying output model file...
if not exist "results\<< output_file >>" (
    echo [%date% %time%] WARNING: Expected output file not found: results\<< output_file >>
    echo Simulation may have completed without saving the model file
    echo Check results\simulation.log for details
) else (
    echo [%date% %time%] Output file verified: results\<< output_file >>
)

REM ============================================================
REM Step 5: Clean up .mph file if save_mph is disabled
REM ============================================================
<% if not save_mph %>
echo.
echo [%date% %time%] Step 5/5: Cleaning up .mph file...
REM Delete all .mph files in job directory (COMSOL may add suffixes like _Model)
for %%f in ("*.mph") do (
    del "%%f"
    echo [%date% %time%] Deleted .mph file: %%f
)
REM Also check results directory
if exist "results\*.mph" (
    for %%f in ("results\*.mph") do (
        del "%%f"
        echo [%date% %time%] Deleted .mph file in results: %%f
    )
)
echo [%date% %time%] Cleanup completed
<% endif %>

REM ============================================================
REM Summary
REM ============================================================
echo.
echo ============================================================
echo Execution Summary
echo ============================================================
echo 1. Compilation: SUCCESS
echo 2. Class file verification: SUCCESS
echo 3. Batch execution: SUCCESS
if exist "results\<< output_file >>" (
    echo 4. Model file verification: SUCCESS
<% if not save_mph %>
    echo 5. MPH file cleanup: SKIPPED ^(file still exists^)
<% endif %>
) else (
<% if save_mph %>
    echo 4. Model file verification: WARNING ^(file not found^)
<% else %>
    echo 4. Model file verification: N/A ^(save disabled^)
    echo 5. MPH file cleanup: SUCCESS
<% endif %>
)
echo ============================================================
echo Results directory: << job_dir >>\results\
echo Compilation log: << job_dir >>\results\compile.log
echo Simulation log: << job_dir >>\results\simulation.log
<% if save_mph %>
echo Model file: << job_dir >>\results\<< output_file >>
<% else %>
echo Model file: NOT SAVED ^(save_mph=false^)
<% endif %>
echo ============================================================

exit /b 0
