# Job Generator Usage Guide

このドキュメントでは、COMSOL Job Generatorの使い方を説明します。

## 概要

Job Generatorは、COMSOL Multiphysics用の格子構造シミュレーションジョブを自動生成するツールです。参照JavaファイルをベースにしてパラメータをカスタマイズしたJavaファイル、バッチファイル、設定ファイルを生成します。

## 基本的な使い方

### 1. 単一ジョブの生成

```python
from src.services import JobGenerator
from pathlib import Path

# ジェネレーターの初期化
generator = JobGenerator(
    template_dir=Path("templates"),  # templates/ must contain simulation.java.j2 and run.bat.j2
    output_base_dir=Path("jobs/comsol")
)

# パラメータの定義
params = {
    'lattice_constant': 1.0,        # 格子定数 (mm)
    'sphere_radius_ratio': 0.15,    # 球の半径比 (15%)
    'bond_radius_ratio': 0.08,      # ボンドの半径比 (8%)
    'num_cells': 3,                 # セル数 (3x3x3)
    'poisson_ratio': 0.3,           # ポアソン比
    'delta': 0.001,                 # ひずみ増分
    'dstep': '"range(0,0.0002,0.001)"',  # 変位ステップ
    'lattice_type': 'FCC',          # 格子タイプ
    'file_name': 'test_fcc_lattice',
}

# ジョブの生成
result = generator.generate_job(
    params=params,
    comsol_command="comsol"  # Windows環境変数PATHにCOMSOLが設定されていること
)

print(f"Job directory: {result['job_dir']}")
print(f"Java file: {result['java_file']}")
print(f"Batch file: {result['batch_file']}")
```

### 2. パラメトリックスタディ（複数ジョブ）の生成

```python
from src.services import JobGenerator
from pathlib import Path

generator = JobGenerator(
    template_dir=Path("templates"),
    output_base_dir=Path("jobs/comsol")
)

# パラメータスイープの定義
sphere_radii = [0.10, 0.15, 0.20]
bond_radii = [0.05, 0.08, 0.10]

jobs = []
for rs in sphere_radii:
    for rb in bond_radii:
        params = {
            'lattice_constant': 1.0,
            'sphere_radius_ratio': rs,
            'bond_radius_ratio': rb,
            'num_cells': 3,
            'poisson_ratio': 0.3,
            'file_name': f'fcc_rs{int(rs*100)}_rb{int(rb*100)}',
        }

        result = generator.generate_job(
            params=params,
            comsol_command="comsol"  # Windows環境変数PATHにCOMSOLが設定されていること
        )
        jobs.append(result)

print(f"Generated {len(jobs)} jobs")
```

## パラメータ説明

### 必須パラメータ

| パラメータ名 | エイリアス | 型 | 説明 | 単位 |
|-------------|-----------|-----|------|------|
| `lattice_constant` | `lconst` | float | 格子定数 | mm |

### オプションパラメータ

| パラメータ名 | エイリアス | 型 | デフォルト値 | 説明 | 範囲 |
|-------------|-----------|-----|------------|------|------|
| `sphere_radius_ratio` | `rs` | float | 0.1 | 球の半径比 | 0 < rs < 0.5 |
| `bond_radius_ratio` | `rb` | float | 0.05 | ボンドの半径比 | 0 < rb < 0.5 |
| `num_cells` | `nnn` | int | 3 | セル数 (nx=ny=nz) | 1以上 |
| `shift` | - | float | 0.0 | 格子点のシフト量 | 0 ≤ shift < 1 |
| `poisson_ratio` | `pratio` | float | 0.3 | ポアソン比 | -1 < ν < 0.5 |
| `delta` | `delta_` | float | 0.001 | ひずみ増分 | > 0 |
| `dstep` | - | str | '"range(0,0.0002,0.001)"' | 変位ステップ | - |
| `lattice_type` | - | str | 'FCC' | 格子タイプ | FCC, BCC, etc. |
| `file_name` | - | str | job_id | 出力ファイル名 | - |
| `d_min` | - | float | 0.0 | ボンド最小距離 | mm |
| `d_max` | - | float | 1.5*lconst | ボンド最大距離 | mm |

## 出力ファイル

各ジョブディレクトリには以下のファイルが生成されます：

```
jobs/comsol/job_YYYYMMDD_HHMMSS/
├── job_YYYYMMDD_HHMMSS.java  # COMSOLシミュレーションJavaファイル
├── run.bat                    # Windows実行用バッチファイル
├── config.yml                 # ジョブ設定ファイル（パラメータ記録）
└── results/                   # 結果出力ディレクトリ
    ├── run.log               # 実行ログ（実行後）
    ├── *_kirchhoff.txt       # Kirchhoff応力（実行後）
    └── *_maxmises.txt        # 最大ミーゼス応力（実行後）
```

### run.bat の内容

バッチファイルはJinja2テンプレート（`templates/run.bat.j2`）から生成されます。

生成されるバッチファイルの例：

```batch
@echo off
REM COMSOL Batch Execution Script
REM Generated by ESP Job Generator
REM Job ID: job_20251112_084501
REM Generated at: 2025-11-12T08:45:01.307731

echo ============================================================
echo COMSOL Simulation Batch Execution
echo ============================================================
echo Job ID: job_20251112_084501
echo Job Directory: /workspace/jobs/comsol/job_20251112_084501
echo Java File: job_20251112_084501.java
echo Class Name: job_20251112_084501
echo Output File: job_20251112_084501.mph
echo ============================================================

cd /d "/workspace/jobs/comsol/job_20251112_084501"

echo [%date% %time%] Starting COMSOL execution...

comsol batch ^
    -inputfile "job_20251112_084501.java" ^
    -outputfile "job_20251112_084501.mph" ^
    > "/workspace/jobs/comsol/job_20251112_084501\results\run.log" 2>&1

set EXIT_CODE=%ERRORLEVEL%

if %EXIT_CODE% neq 0 (
    echo [%date% %time%] ERROR: COMSOL execution failed with exit code %EXIT_CODE%
    echo Check log file: /workspace/jobs/comsol/job_20251112_084501\results\run.log
    exit /b %EXIT_CODE%
)

echo [%date% %time%] COMSOL execution completed successfully
echo Results saved to: /workspace/jobs/comsol/job_20251112_084501\results\
echo ============================================================
exit /b 0
```

**特徴:**
- タイムスタンプ付きログメッセージ
- ジョブIDと生成日時の記録
- 詳細なエラーメッセージ
- Jinja2テンプレートベースでカスタマイズ可能

**注意:** `comsol`コマンドがWindows環境変数PATHに設定されていることを前提としています。

### カスタムCOMSOLコマンドの指定

環境によって異なるCOMSOLコマンド名やフルパスを使用する場合：

```python
# デフォルト（PATHにある場合）
result = generator.generate_job(params, comsol_command="comsol")

# カスタムコマンド名
result = generator.generate_job(params, comsol_command="comsol61")

# フルパス指定（推奨されませんが可能）
result = generator.generate_job(
    params,
    comsol_command=r"C:\Program Files\COMSOL\COMSOL61\Multiphysics\bin\win64\comsol.exe"
)
```

## パラメータ検証

パラメータの妥当性を事前にチェックするには：

```python
from src.services import validate_parameters

params = {
    'lattice_constant': 1.0,
    'sphere_radius_ratio': 0.15,
    'bond_radius_ratio': 0.08,
}

try:
    validate_parameters(params)
    print("✓ Parameters are valid")
except ValueError as e:
    print(f"✗ Invalid parameters: {e}")
```

## テンプレートファイル

Job Generatorは以下のJinja2テンプレートを使用します：

### `templates/simulation.java.j2`

COMSOL Javaシミュレーションファイルのテンプレート。以下の変数が利用可能です：

- `class_name`: Javaクラス名
- `file_name`: 出力ファイル名
- `output_path`: 結果出力パス
- `stl_path`: STLファイルパス
- `lattice_constant`: 格子定数
- `sphere_radius_ratio`: 球の半径比
- `bond_radius_ratio`: ボンドの半径比
- `poisson_ratio`: ポアソン比
- `shift`: 格子点のシフト量
- `num_cells`: セル数
- `lattice_type`: 格子タイプ (fcc, bcc, etc.)
- `delta`: ひずみ増分
- `dstep`: 変位ステップ
- `d_min`, `d_max`: ボンド距離範囲
- `eps`: 微小値

### `templates/run.bat.j2`

バッチファイルのテンプレート（上記「カスタムCOMSOLコマンドの指定」を参照）

## トラブルシューティング

### エラー: Template not found

**原因:** `templates/simulation.java.j2` または `templates/run.bat.j2` が見つかりません。

**解決策:**
```python
from pathlib import Path

template_dir = Path("templates")
required_templates = ["simulation.java.j2", "run.bat.j2"]

for template in required_templates:
    template_path = template_dir / template
    if not template_path.exists():
        print(f"✗ Template not found: {template_path}")
```

### エラー: Invalid parameters

**原因:** パラメータの値が許容範囲外です。

**解決策:** パラメータの範囲を確認してください（上記の「パラメータ説明」を参照）。

### ジョブIDの衝突

ジョブIDはタイムスタンプベースで自動生成されます。同じ秒に複数のジョブを生成すると衝突する可能性があります。

**解決策:** カスタムjob_idを指定してください。
```python
result = generator.generate_job(
    params=params,
    comsol_exe_path="...",
    job_id="my_custom_job_001"
)
```

## 統合例

Optunaを使った最適化との統合：

```python
import optuna
from src.services import JobGenerator

def objective(trial):
    # パラメータのサンプリング
    rs = trial.suggest_float('sphere_radius_ratio', 0.05, 0.25)
    rb = trial.suggest_float('bond_radius_ratio', 0.03, 0.15)

    # ジョブ生成
    generator = JobGenerator(...)
    params = {
        'lattice_constant': 1.0,
        'sphere_radius_ratio': rs,
        'bond_radius_ratio': rb,
        'num_cells': 3,
    }

    result = generator.generate_job(params, comsol_command="comsol")

    # ここでジョブを実行し、結果を解析
    # （batch_executor, result_analyzerを使用）

    # 目的関数値を返す
    return objective_value

study = optuna.create_study(direction='maximize')
study.optimize(objective, n_trials=100)
```

## テンプレートのカスタマイズ

バッチファイルのテンプレート（`templates/run.bat.j2`）は自由にカスタマイズできます。

### 利用可能なテンプレート変数

- `job_id`: ジョブID
- `job_dir`: ジョブディレクトリパス
- `java_file_name`: Javaファイル名
- `class_name`: Javaクラス名
- `output_file`: 出力ファイル名（.mph）
- `comsol_command`: COMSOLコマンド
- `generated_at`: 生成日時（ISO形式）

### テンプレートの例

```jinja2
@echo off
REM Custom COMSOL Batch Script
REM Job: {{ job_id }}

cd /d "{{ job_dir }}"

{{ comsol_command }} batch ^
    -inputfile "{{ java_file_name }}" ^
    -outputfile "{{ output_file }}" ^
    > "{{ job_dir }}\results\run.log" 2>&1

if %ERRORLEVEL% neq 0 (
    echo ERROR: Simulation failed
    exit /b %ERRORLEVEL%
)

echo SUCCESS: Simulation completed
exit /b 0
```

## 関連ドキュメント

- [プロジェクト設計書](project_design.md)
- [データベース設計](database.md)
- [CLAUDE.md](../CLAUDE.md) - Claude Codeの開発ガイド
- [run.bat.j2テンプレート](../templates/run.bat.j2) - バッチファイルテンプレート
